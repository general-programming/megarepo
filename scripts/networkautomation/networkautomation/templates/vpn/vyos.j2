{% include 'common/vyos.j2' %}

{% for link in links %}
    {%- set interface_name = "wg" ~ link.link_id -%}
    {%- set port = link.link_id -%}
    {%- if link.side_a == device -%}
        {%- set our_side = link.side_a -%}
        {%- set other_peer = link.side_b -%}
    {%- else -%}
        {%- set our_side = link.side_b -%}
        {%- set other_peer = link.side_a -%}
    {%- endif -%}
set interfaces wireguard {{ interface_name }} description '{{ link.side_a.hostname }} -> {{ link.side_b.hostname }}'
set interfaces wireguard {{ interface_name }} address {{ link.get_ip(our_side) }}/31
set interfaces wireguard {{ interface_name }} private-key '{{ our_side.privkey(port) }}'
set interfaces wireguard {{ interface_name }} port {{ port }}
set interfaces wireguard {{ interface_name }} peer {{ other_peer.hostname }} public-key '{{ other_peer.pubkey(port) }}'
set interfaces wireguard {{ interface_name }} peer {{ other_peer.hostname }} allowed-ips 0.0.0.0/0
    {% if other_peer.address %}
set interfaces wireguard {{ interface_name }} peer {{ other_peer.hostname }} address {{ other_peer.address }}
set interfaces wireguard {{ interface_name }} peer {{ other_peer.hostname }} port {{ port }}
set interfaces wireguard {{ interface_name }} peer {{ other_peer.hostname }} persistent-keepalive 10
    {% endif %}
set protocols bgp neighbor {{ link.get_ip(other_peer) }} remote-as {{ other_peer.asn }}
set protocols bgp neighbor {{ link.get_ip(other_peer) }} update-source {{ interface_name }}
{% if other_peer.is_spine %}
set protocols bgp neighbor {{ link.get_ip(other_peer) }} peer-group spine
{% else %}
set protocols bgp neighbor {{ link.get_ip(other_peer) }} peer-group leaf
{% endif %}
{% endfor -%}

{% for network in device.networks %}
set protocols bgp address-family ipv4-unicast network {{ network }}
{% endfor -%}

set protocols bgp local-as '{{ device.asn }}'
set protocols bgp peer-group leaf address-family ipv4-unicast
set protocols bgp peer-group leaf ebgp-multihop '6'
set protocols bgp peer-group spine address-family ipv4-unicast
set protocols bgp peer-group spine ebgp-multihop '6'
set protocols bgp timers keepalive 10
set protocols bgp timers holdtime 30

{% include 'common/all_suffix.j2' %}
