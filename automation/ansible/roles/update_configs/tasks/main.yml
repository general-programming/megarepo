---
- name: "Settings - Install HSM root CA"
  ansible.builtin.copy:
    src: "root_ca.crt"
    dest: "/etc/ssl/certs/General_Programming_Root.pem"
    mode: 0644

- name: "Settings - Set swappiness to 0"
  ansible.posix.sysctl:
    name: vm.swappiness
    value: 1
    state: present
    reload: true

- name: "Settings - Enable kernel IP forwarding for app server."
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: 1
    state: present
    reload: true
  when: "(appserver or hypervisor or ip_forward)"

- name: "Settings - Update global byobu statusrc"
  ansible.builtin.copy:
    src: byobu_status
    dest: /usr/share/byobu/status/status
    owner: root
    group: root
    mode: 0644

- name: "Settings - Set timezone to UTC"
  community.general.timezone:
    name: UTC

- name: "Settings - Check if Consul config folder exists."
  ansible.builtin.stat:
    path: "/etc/consul.d/"
  register: consul_folder

- name: "Settings - Check if node exporter is installed"
  ansible.builtin.stat:
    path: "/usr/local/bin/node_exporter"
  register: node_exporter_bin

- name: "Settings - Add node_exporter Consul service."
  ansible.builtin.copy:
    src: consul_node_exporter.json
    dest: /etc/consul.d/service_node_exporter.json
    owner: root
    group: root
    mode: 0644
  when: node_exporter_bin.stat.exists and consul_folder.stat.exists and consul_folder.stat.isdir

- name: "Settings - Install admin SSH keys for root."
  ansible.builtin.copy:
    src: authorized_keys
    dest: /root/.ssh/authorized_keys
    owner: root
    group: root
    mode: 0644
